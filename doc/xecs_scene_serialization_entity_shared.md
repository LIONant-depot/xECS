<img src="https://i.imgur.com/TyjrCTS.jpg" align="right" width="220px" /><br>
# [xECS](xecs.md) / [Scene](xecs_scene.md) / [Serialization](xecs_scene_serialization.md) / [Entity](xecs_scene_serialization_entity.md) / Share

Share-Entities are entities generated by xECS to hold the share-components as well as additional data. These shared entities are reference by the Archetype Families. These entities are created and destroy by xECS without the user control, as such these Entities are used by all other entity types through their families.

The [share-component](xecs_component_types_share.md) is the only part of these entities that it could change from version to version since all other components for these entities are system level component where the user has no control over them.

## Identifying which share-entities to save

To identify which share-entities to save is not easy. We must go throw all the Entities in Scene, visit their families and collect each individual share-entities into a hash table. This hash-map will let us know if we already put a particular share-entity id in the list or not. Note that for entities that are prefabs instances wont participate in this process, only raw local-entities and raw global-entities.

~~~cpp
//  When Saving 
//  Hash-Map of share-entity ids
    +-------------+      +------------------+
    |  Entity-ID  | ---> | bool I am mapped |
    +-------------+      +------------------+
    |  Entity-ID  |
    +-------------+
    +-------------+
~~~

The EntityID for this share-entities is important because the other entities will reference these ones by their entity-id rather than their share-keys values since those can possibly change at runtime.

Ones we have collected all the entities into our hash map we must group them base on their archetype as well. This way when we serialize everything will be faster. To determine which Archetypes we should use at save time we will again use another hash map which maps between the pointer of the Archetype with a vector of share-entities ids.

~~~cpp
//  When Saving
//  Hash-Map of Archetypes to a vector of entity_id
    +-------------------+      +----------------+
    | Archetype Pointer | ---> | vector<entity> |
    +-------------------+      +----------------+
    | Archetype Pointer |
    +-------------------+
    +-------------------+
~~~

At this point we not longer need the first hash-map and we can do the remainder of saving work with this second hash map.

At load time we will need a hash map which maps the saved entity-id with the real entity-ids. After the loading is done this hash-map will be destroy.

~~~cpp
//  When Loading
//  Hash-Map of share-entity ids
    +------------------+      +-------------------+
    | Saved-Entity-ID  | ---> | Runtime-Entity-ID |
    +------------------+      +-------------------+
    | Saved-Entity-ID  |
    +------------------+
    +------------------+
~~~

When loading these share-entities will be created, however at the end of the loading process we will go thought them and any share-entity which has accumulated zero references will be removed. This can happen if some of the prefab-instances ..................................?

-------
